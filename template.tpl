___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "GA4 Advanced",
  "brand": {
    "id": "brand_dummy",
    "displayName": "",
    "thumbnail": "data:image/png;base64,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\u003d\u003d"
  },
  "description": "GA4 Tag powered by stape.",
  "containerContexts": [
    "SERVER"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "TEXT",
    "name": "measurementId",
    "displayName": "Measurement ID",
    "simpleValueType": true,
    "help": "If the event came from a GA4 web tag, you can leave this field blank to inherit the measurement ID of the event",
    "valueHint": "G-1234567890"
  },
  {
    "type": "SELECT",
    "name": "redactVisitorIP",
    "displayName": "Redact visitor IP address",
    "macrosInSelect": true,
    "selectItems": [
      {
        "value": false,
        "displayValue": "false"
      },
      {
        "value": true,
        "displayValue": "true"
      }
    ],
    "simpleValueType": true,
    "help": "Remove visitor IP address from the event. Reports based on the event will not include geographic information."
  },
  {
    "type": "TEXT",
    "name": "eventName",
    "displayName": "Event Name",
    "simpleValueType": true,
    "help": "The event name to send to Google. See the \u003ca href\u003d\"https://developers.google.com/analytics/devguides/collection/ga4/events?client_type\u003dgtag\" target\u003d\"_blank\"\u003erecommended events\u003c/a\u003e for more information. If this field is blank, the value of the event_name parameter will be sent.",
    "valueHint": "Defaults to event.event_name"
  },
  {
    "type": "GROUP",
    "name": "eventParametersGroup",
    "displayName": "Event Parameters",
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "SELECT",
        "name": "defaultParametersToInclude",
        "displayName": "Default Parameters to Include",
        "macrosInSelect": false,
        "selectItems": [
          {
            "value": "all",
            "displayValue": "All"
          },
          {
            "value": "none",
            "displayValue": "None"
          }
        ],
        "simpleValueType": true,
        "help": "Specify which event parameters to send to Google by default. Do not send personally identifiable information (PII) to Google Analytics. See the \u003ca href\u003d\"https://developers.google.com/analytics/devguides/collection/app-web/policy\" target\u003d\"_blank\"\u003edocumentation\u003c/a\u003e for more details. The following parameters are excluded regardless of the selected option: first_name, last_name, email_address, phone_number, address"
      },
      {
        "type": "SIMPLE_TABLE",
        "name": "parametersToExclude",
        "displayName": "Parameters to Exclude",
        "simpleTableColumns": [
          {
            "defaultValue": "",
            "displayName": "Name",
            "name": "name",
            "type": "TEXT",
            "isUnique": true,
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ]
          }
        ],
        "help": "Event parameters listed here will not be sent to Google.",
        "newRowButtonText": "+ Add param"
      },
      {
        "type": "PARAM_TABLE",
        "name": "parametersToOverride",
        "displayName": "Parameters to Add / Edit",
        "paramTableColumns": [
          {
            "param": {
              "type": "TEXT",
              "name": "name",
              "displayName": "Name",
              "simpleValueType": true
            },
            "isUnique": true
          },
          {
            "param": {
              "type": "TEXT",
              "name": "value",
              "displayName": "Value",
              "simpleValueType": true
            },
            "isUnique": false
          },
          {
            "param": {
              "type": "CHECKBOX",
              "name": "addParam",
              "checkboxText": "Add if not exists",
              "simpleValueType": true
            },
            "isUnique": false
          }
        ],
        "help": "Event parameters listed here will be added to the event sent to Google. If the event parameter is already included, then the value will be replaced with the specified value.",
        "newRowButtonText": "+ Add param"
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "userPropertiesGroup",
    "displayName": "User Properties",
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "SELECT",
        "name": "defaultUserPropertiesToInclude",
        "displayName": "Default Properties to Include",
        "macrosInSelect": false,
        "selectItems": [
          {
            "value": "all",
            "displayValue": "All"
          },
          {
            "value": "none",
            "displayValue": "None"
          }
        ],
        "simpleValueType": true,
        "help": "Specify which user properties to send to Google by default."
      },
      {
        "type": "SIMPLE_TABLE",
        "name": "userPropertiesToExclude",
        "displayName": "Properties to Exclude",
        "simpleTableColumns": [
          {
            "defaultValue": "",
            "displayName": "Name",
            "name": "name",
            "type": "TEXT",
            "isUnique": true,
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ]
          }
        ],
        "help": "User properties listed here will not be sent to Google"
      },
      {
        "type": "SIMPLE_TABLE",
        "name": "userPropertiesToAdd",
        "displayName": "Properties to Add / Edit",
        "simpleTableColumns": [
          {
            "defaultValue": "",
            "displayName": "Name",
            "name": "name",
            "type": "TEXT",
            "isUnique": true,
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ]
          },
          {
            "defaultValue": "",
            "displayName": "Value",
            "name": "value",
            "type": "TEXT",
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ]
          }
        ],
        "help": "User properties listed here will be added to the event sent to Google. If the user property is already included, then the value will be replaced with the specified value."
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "requestHeadersGroup",
    "displayName": "Request Headers",
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "PARAM_TABLE",
        "name": "requestHeaders",
        "displayName": "",
        "paramTableColumns": [
          {
            "param": {
              "type": "TEXT",
              "name": "name",
              "displayName": "Name",
              "simpleValueType": true,
              "valueValidators": [
                {
                  "type": "NON_EMPTY"
                }
              ]
            },
            "isUnique": true
          },
          {
            "param": {
              "type": "TEXT",
              "name": "value",
              "displayName": "Value",
              "simpleValueType": true
            },
            "isUnique": false
          }
        ],
        "newRowButtonText": "+ Add header"
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "dataSourceGroup",
    "displayName": "Data Source Settings",
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "RADIO",
        "name": "dataSource",
        "displayName": "",
        "radioItems": [
          {
            "value": "request",
            "displayValue": "Incoming Request"
          },
          {
            "value": "eventData",
            "displayValue": "Event Data (Beta)",
            "help": ""
          }
        ],
        "simpleValueType": true,
        "defaultValue": "request"
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "logSettingsGroup",
    "displayName": "Logs Settings",
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "RADIO",
        "name": "logType",
        "displayName": "",
        "radioItems": [
          {
            "value": "no",
            "displayValue": "Do not log"
          },
          {
            "value": "debug",
            "displayValue": "Log to console during debug and preview"
          },
          {
            "value": "always",
            "displayValue": "Always log to console"
          }
        ],
        "simpleValueType": true,
        "defaultValue": "debug"
      }
    ]
  }
]


___SANDBOXED_JS_FOR_SERVER___

const logToConsole = require('logToConsole');
const getContainerVersion = require('getContainerVersion');
const getRequestHeader = require('getRequestHeader');
const getAllEventData = require('getAllEventData');
const getRequestBody = require('getRequestBody');
const getRequestQueryParameters = require('getRequestQueryParameters');
const encodeUriComponent = require('encodeUriComponent');
const JSON = require('JSON');
const parseUrl = require('parseUrl');
const Object = require('Object');
const sendHttpRequest = require('sendHttpRequest');
const getType = require('getType');

const isLoggingEnabled = determinateIsLoggingEnabled();
const traceId = getRequestHeader('trace-id');

const userAgent = getRequestHeader('User-Agent');
const eventData = getAllEventData();
const eventName = data.eventName ? data.eventName : eventData.event_name;
let postUrl = 'https://www.google-analytics.com/g/collect';
const queryParams = getQueryParams();
const events = getEvents();

// For cases when there's only one event and it's in the request body (big GA4 payloads).
if (events.length === 1 && events[0].en && !queryParams.en) {
  events[0].en = eventName;
}

// For cases when there's only one event and it's in the request URL.
if (events.length === 0 && queryParams.en) {
  queryParams.en = eventName;
}

if (data.measurementId) {
  queryParams.tid = data.measurementId;
}

if ([false, 'false', 0].indexOf(data.redactVisitorIP) === -1) {
  queryParams._uip = '::';
  Object.delete(queryParams, 'ep.ip_override');
}

if (data.parametersToExclude && data.parametersToExclude.length) {
  data.parametersToExclude.forEach((param) => {
    Object.delete(queryParams, param.name);
    events.forEach((event) => {
      Object.delete(event, param.name);
    });
  });
}

if (data.parametersToOverride && data.parametersToOverride.length) {
  data.parametersToOverride.forEach((param) => {
    if (isValidParam(queryParams[param.name]) || param.addParam) {
      queryParams[param.name] = param.value;
    }
    events.forEach((event) => {
      if (isValidParam(event[param.name])) {
        event[param.name] = param.value;
      }
    });
  });
}

if (data.userPropertiesToExclude && data.userPropertiesToExclude.length) {
  data.userPropertiesToExclude.forEach((property) => {
    deleteUserProperty(queryParams, property.name);
    events.forEach((event) => {
      deleteUserProperty(event, property.name);
    });
  });
}

if (data.userPropertiesToAdd && data.userPropertiesToAdd.length) {
  const target = events.length ? events[0] : queryParams;
  data.userPropertiesToAdd.forEach((property) => {
    target['up.' + property.name] = property.value;
  });
}

const queryParamsString = objectToQueryString(queryParams);
if (queryParamsString) {
  postUrl = postUrl + '?' + queryParamsString;
}
const body = events.length
  ? events.map(objectToQueryString).join('\n')
  : undefined;
const headers = {
  'Content-Type': 'text/plain;charset=UTF-8',
  'User-Agent': userAgent
};

if (data.requestHeaders && data.requestHeaders.length) {
  data.requestHeaders.forEach((header) => {
    headers[header.name] = header.value;
  });
}

if (isLoggingEnabled) {
  logToConsole(
    JSON.stringify({
      Name: 'GA4Advanced',
      Type: 'Request',
      TraceId: traceId,
      EventName: eventName
    })
  );
}

sendHttpRequest(
  postUrl,
  {
    headers: headers,
    method: 'POST'
  },
  body
)
  .then((response) => {
    if (isLoggingEnabled) {
      logToConsole(
        JSON.stringify({
          Name: 'GA4Advanced',
          Type: 'Response',
          TraceId: traceId,
          EventName: eventName,
          ResponseStatusCode: response.statusCode,
          ResponseHeaders: response.headers,
          ResponseBody: response.body
        })
      );
    }
    data.gtmOnSuccess();
  })
  .catch(() => {
    data.gtmOnFailure();
  });

function getQueryParams() {
  if (data.defaultParametersToInclude === 'none') return {};
  if (data.dataSource === 'request') return getQueryParamsFromRequest();
  return getQueryParamsFromEventData();
}

function getEvents() {
  if (data.dataSource === 'eventData') return [];
  const requestBody = getRequestBody();
  const requestBodyLines = requestBody ? requestBody.split('\n') : [];
  return requestBodyLines.map((requestBodyLine) => {
    return parseUrl('https://parse.com?' + requestBodyLine).searchParams;
  });
}

function getQueryParamsFromRequest() {
  const params = getRequestQueryParameters();
  if (data.defaultUserPropertiesToInclude === 'none') {
    Object.keys(params).forEach((key) => {
      if (key.indexOf('upn.') === 0 || key.indexOf('up.') === 0) {
        Object.delete(params, key);
      }
    });
  }
  return params;
}

function getQueryParamsFromEventData() {
  const params = {};
  const clientHints = eventData.client_hints || {};
  const settings = [
    /**
     * Request parameters:
     */
    {
      param: 'v', // (Protocol Version)
      value: eventData['x-ga-protocol_version']
    },
    {
      param: 'tid', // (Tracking ID)
      value: eventData['x-ga-measurement_id']
    },
    {
      param: 'gtm', // (GTM Hash Info),
      value: eventData['x-ga-gtm_version']
    },
    {
      param: '_p', // (Random Page Load Hash)
      value: eventData['x-ga-page_id']
    },
    {
      param: 'sr', // (Screen Resolution),
      value: eventData['screen_resolution']
    },
    {
      param: 'ul', // (User Language),
      value: eventData['language']
    },
    {
      param: 'dh', // (Document Hostname)
      value: undefined
    },
    {
      param: 'cid', // (client Id),
      value: eventData['client_id']
    },
    {
      param: '_s', // (Hit Counter)
      value: undefined
    },
    {
      param: 'richsstsse', // (richsstsse)
      value: undefined // param without value in query params, how to handle ???
    },
    /**
     * Shared:
     */
    {
      param: 'dl', // (Document location),
      value: eventData['page_location']
    },
    {
      param: 'dt', // (Document title)
      value: eventData['page_title']
    },
    {
      param: 'dr', // (Document referrer)
      value: undefined
    },
    {
      param: '_z', // (_z) - some hash
      value: undefined
    },
    {
      param: '_eu', // (Event usage)
      value: undefined
    },
    {
      param: 'edid', // (Event Debug ID?)
      value: undefined
    },
    {
      param: '_dbg', // (is Debug)
      value: eventData.debug_mode === 'true' ? 1 : undefined
    },
    {
      param: 'ir', // (Ignore Referrer)
      value: undefined
    },
    {
      param: 'tt', // (Traffic Type)
      value: undefined
    },
    {
      param: 'gcs', // (Google Consent Status)
      value: undefined
    },
    {
      param: 'gcu', // (Google Consent Update)
      value: undefined
    },
    {
      param: 'gcut', // (Google Consent Update Type)
      value: undefined
    },
    {
      param: 'gcd', // (Google Consent Default)
      value: undefined
    },
    {
      param: '_glv', // (is Google Linker Valid)
      value: undefined
    },
    /**
     * Event Parameters:
     */
    {
      param: 'en', // (Event Name)
      value: eventName
    },
    {
      param: '_et', // (Engagement Time)
      value: eventData.engagement_time_msec
    },
    {
      param: '_c', // is Conversion
      value: eventData['x-ga-system_properties']
        ? eventData['x-ga-system_properties'].c
        : undefined
    },
    {
      param: '_ee', // external event
      value: undefined
    },
    {
      param: 'ep.debug_mode',
      value: eventData.debug_mode
    },
    {
      param: 'ep.event_id',
      value: eventData.event_id
    },
    {
      param: 'ep.value',
      value: eventData.value
    },
    {
      param: 'ep.transaction_id',
      value: eventData.transaction_id
    },
    {
      param: 'ep.tax',
      value: eventData.tax
    },
    {
      param: 'ep.shipping',
      value: eventData.shipping
    },
    {
      param: 'ep.payment_type',
      value: eventData.payment_type
    },
    {
      param: 'ep.city',
      value: eventData.city
    },
    {
      param: 'ep.phone',
      value: eventData.phone
    },
    {
      param: 'ep.object',
      value: eventData.object
    },
    {
      param: 'ep.long',
      value: eventData.long
    },
    {
      param: 'ep.cyr',
      value: eventData.cyr
    },
    {
      param: 'ep.cyrl',
      value: eventData.cyrl
    },
    {
      param: 'ep.percent_scrolled',
      value: eventData.percent_scrolled
    },
    {
      param: 'ep.plays_count',
      value: eventData.plays_count
    },
    /**
     * E-Commerce Main:
     */
    {
      param: 'cu', // Currency Code
      value: eventData.currency
    },
    {
      param: 'ep.affiliation', // Affiliation
      value: undefined
    },
    {
      param: 'epn.value', // Transaction Revenue
      value: eventData.value // ???
    },
    {
      param: 'epn.tax', // Transaction Tax
      value: eventData.tax // ???
    },
    {
      param: 'epn.shipping', // Transaction Shipping
      value: eventData.shipping // ???
    },
    {
      param: 'pi', // Promotion ID
      value: undefined
    },
    {
      param: 'pn', // Promotion Name
      value: undefined
    },
    {
      param: 'cn', // Creative Name
      value: undefined
    },
    {
      param: 'cs', // Creative Slot
      value: undefined
    },
    {
      param: 'lo', // Location id
      value: undefined
    },
    /**
     * Campaign Attribution:
     */
    {
      param: 'cm', // Campaign Medium
      value: undefined
    },
    {
      param: 'cs', // Campaign Source
      value: undefined
    },
    {
      param: 'cn', // Campaign Name
      value: undefined
    },
    {
      param: 'cc', // Campaign Content
      value: undefined
    },
    {
      param: 'ck', // Campaign Term
      value: undefined
    },
    {
      param: 'ccf', // Campaign Creative Format
      value: undefined
    },
    {
      param: '_rnd', // Gclid Deduper
      value: undefined
    },
    // Session / User Related:
    {
      param: 'uid', // User Id
      value: eventData.user_id
    },
    {
      param: '_fid', // Firebase Id
      value: eventData.firebase_id // ???
    },
    {
      param: 'sid', // Session Id
      value: eventData.ga_session_id
    },
    {
      param: 'sct', // Session count
      value: eventData.ga_session_number
    },
    {
      param: 'seg', // Session Engagement
      value: eventData['x-ga-mp2-seg'] // ???
    },
    {
      param: '_fv', // First Visit
      value: undefined // If the "_ga_THYNGSTER" cookie is not set, the first event will have this value present. This will internally create a new "first_visit" event on GA4. If this event is also a conversion the value will be "2" if not, will be "1"
    },
    {
      param: '_ss', // Session start
      value: undefined // If the "_ga_THYNGSTER" cookie last session time value is older than 1800 seconds, the current event will have this value present. This will internally create a new "session_start" event on GA4. If this event is also a conversion the value will be "2" if not, will be "1"
    },
    {
      param: '_fplc', // First Party Linker Cookie
      value: undefined
    },
    {
      param: '_nsi', // New Session Id
      value: undefined
    },
    {
      param: 'gdid', // Google Developer ID
      value: undefined
    },
    {
      param: '_uc', // User Country
      value: undefined
    },
    // Client Hints:
    {
      param: 'uaa', // User Agent Architecture
      value: clientHints.architecture
    },
    {
      param: 'uab', // User Agent Bitness
      value: clientHints.bitness
    },
    {
      param: 'uafvl', // User Agent Full Version List
      value: clientHints.full_version_list
        ? clientHints.full_version_list
            .map((item) => {
              return (
                encodeUriComponent(item.brand) +
                ';' +
                encodeUriComponent(item.version)
              );
            })
            .join('|')
        : undefined
    },
    {
      param: 'uamb', // User Agent Mobile
      value: clientHints.mobile ? 1 : 0
    },
    {
      param: 'uam', // User Agent Model
      value: clientHints.model
    },
    {
      param: 'uap', // User Agent Platform
      value: clientHints.platform
    },
    {
      param: 'uapv', // User Agent Platform Version
      value: clientHints.platform_version
    },
    {
      param: 'uaw', // User Agent WOW64
      value: clientHints.wow64 ? 1 : 0
    },
    /**
     * Uncategorized / Missing Info:
     */
    {
      param: 'gtm_up', //
      value: undefined
    },
    {
      param: '_ecid', // European Consent Mode Enabled ID
      value: undefined
    },
    {
      param: '_uei', //
      value: undefined
    },
    {
      param: '_gaz', // Create Google Join
      value: undefined
    },
    {
      param: '_rdi', // Redact Device Info
      value: undefined // Maybe data.redactVisitorIP ???
    },
    {
      param: '_geo', // Geo Granularity
      value: undefined
    },
    {
      param: 'us_privacy', // US Privacy Signal
      value: undefined
    },
    {
      param: 'gdpr', // GDPR applies or not (IAB TCFv2)
      value: undefined
    },
    {
      param: 'gdpr_consent', // GDPR Vendors Lists IDs (GVL ID)(IAB TCFv2)
      value: undefined
    }
  ];
  /**
   * Items Parameters
   */
  if (eventData.items && eventData.items.length) {
    eventData.items.forEach((item) => {
      const value = [
        {
          param: 'id',
          value: item.item_id
        },
        {
          param: 'nm',
          value: item.item_name
        },
        {
          param: 'ln',
          value: item.item_list_name
        },
        {
          param: 'ln',
          value: item.item_list_id
        },
        {
          param: 'br',
          value: item.item_brand
        },
        {
          param: 'ca',
          value: item.item_category
        },
        {
          param: 'ca2', // c2 or ca2 ??? ga4 base - c2 but https://www.thyngster.com/ga4-measurement-protocol-cheatsheet/ - ca2
          value: item.item_category2
        },
        {
          param: 'ca3',
          value: item.item_category3
        },
        {
          param: 'ca4',
          value: item.item_category4
        },
        {
          param: 'ca5',
          value: item.item_category5
        },
        {
          param: 'va',
          value: item.item_variant
        },
        {
          param: 'lp',
          value: item.index
        },
        {
          param: 'qt',
          value: item.quantity
        },
        {
          param: 'pr',
          value: item.price
        },
        {
          param: 'cp',
          value: item.coupon // ??
        },
        {
          param: 'ds',
          value: item.discount // ??
        },
        {
          param: 'af',
          value: item.affiliation // ??
        }
      ];
      settings.push({
        param: 'pr' + item.index,
        value: value
          .filter((setting) => isValidParam(setting.value))
          .map((setting) => setting.param + setting.value)
          .join('~')
      });
    });
  }
  /**
   * User properties
   */
  if (data.defaultUserPropertiesToInclude === 'all') {
    const userProperties = eventData['x-ga-mp2-user_properties'] || {};
    Object.keys(userProperties).forEach((key) => {
      settings.push({
        param: 'up.' + key,
        value: userProperties[key]
      });
    });
  }
  settings.forEach((setting) => {
    if (isValidParam(setting.value)) {
      params[setting.param] = setting.value;
    }
  });
  return params;
}

function deleteUserProperty(obj, propertyName) {
  if (obj['up.' + propertyName]) {
    Object.delete(obj, 'up.' + propertyName);
  }
  if (obj['upn.' + propertyName]) {
    Object.delete(obj, 'upn.' + propertyName);
  }
}

function objectToQueryString(obj) {
  return Object.keys(obj)
    .map((key) =>
      isValidParam(obj[key]) ? key + '=' + encodeUriComponent(obj[key]) : key
    )
    .join('&');
}

function determinateIsLoggingEnabled() {
  const containerVersion = getContainerVersion();
  const isDebug = !!(
    containerVersion &&
    (containerVersion.debugMode || containerVersion.previewMode)
  );

  if (!data.logType) {
    return isDebug;
  }

  if (data.logType === 'no') {
    return false;
  }

  if (data.logType === 'debug') {
    return isDebug;
  }

  return data.logType === 'always';
}

function isValidParam(value) {
  const valueType = getType(value);
  return valueType !== 'undefined' && valueType !== 'null' && value !== '';
}


___SERVER_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "read_request",
        "versionId": "1"
      },
      "param": [
        {
          "key": "queryParametersAllowed",
          "value": {
            "type": 8,
            "boolean": true
          }
        },
        {
          "key": "bodyAllowed",
          "value": {
            "type": 8,
            "boolean": true
          }
        },
        {
          "key": "headersAllowed",
          "value": {
            "type": 8,
            "boolean": true
          }
        },
        {
          "key": "pathAllowed",
          "value": {
            "type": 8,
            "boolean": true
          }
        },
        {
          "key": "queryParameterAccess",
          "value": {
            "type": 1,
            "string": "any"
          }
        },
        {
          "key": "requestAccess",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "headerAccess",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "all"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "read_container_data",
        "versionId": "1"
      },
      "param": []
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "read_event_data",
        "versionId": "1"
      },
      "param": [
        {
          "key": "eventDataAccess",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "send_http",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedUrls",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "allowGoogleDomains",
          "value": {
            "type": 8,
            "boolean": true
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios: []


___NOTES___

Created on 07/03/2023, 14:08:00


